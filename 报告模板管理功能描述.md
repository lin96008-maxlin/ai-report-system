# 报告模板管理功能描述

## 概述

报告模板管理模块是大数据运营分析平台中“智能报告管理”子系统的核心组成部分。它允许用户通过自定义或拼接现有“维度”的方式，灵活地创建和管理各类报告模板。这些模板不仅定义了报告的结构和内容，还集成了数据指标和关联工单的配置，为AI编码软件自动生成系统提供了可执行的蓝图。通过本模块，用户可以高效地构建满足城市治理领域多样化需求的智能报告。

## 一、一级页面：模板列表

### 页面功能

模板列表页面是所有已创建报告模板的集中展示和管理中心。它提供了一个直观的界面，用户可以浏览、查询、新增、批量删除以及管理模板的发布状态。

### 页面布局与元素

1.  **内容区域 - 页面名称**：
    *   **名称**：模板管理
    *   **功能**：清晰标识当前页面的主题。

2.  **内容区域 - 查询条件**：
    *   **功能**：提供过滤和搜索报告模板的条件，帮助用户快速定位目标模板。
    *   **查询字段**：
        *   **模板名称**：文本输入框，支持模糊查询。
        *   **模板描述**：文本输入框，支持模糊查询。
        *   **模板类型**：下拉选择器，选项包括“日报”、“周报”、“月报”、“季报”、“半年报”、“年报”、“专题报告”。支持多选或单选。
    *   **操作**：
        *   **查询按钮**：根据输入的条件筛选模板卡片列表。
        *   **重置按钮**：清空所有查询条件。

3.  **操作栏**：
    *   **功能**：提供对模板卡片列表的整体操作。
    *   **操作按钮**：
        *   **新增模板**：点击后跳转至“新增/编辑模板”二级页面，用于创建新的报告模板。
        *   **批量删除**：当有模板卡片被选中时可用。点击后弹出确认框，确认后批量删除选中的模板。删除时需考虑权限和关联性检查（例如，若模板已被引用或处于发布状态，是否允许删除或给出提示）。
        *   **批量发布**：当有模板卡片被选中时可用。点击后将选中的模板发布为MCP服务，使其可被大模型调用。发布后，相应的模板卡片上的操作将变为“取消发布”。
        *   **批量取消发布**：当有模板卡片被选中且处于发布状态时可用。点击后取消选中的模板的MCP服务发布状态，使其不再被大模型调用。

4.  **模板卡片列表**：
    *   **布局**：建议采用多列布局，例如网格布局，每行显示2-4个卡片，以提高信息密度和视觉效果。
    *   **卡片信息**：每个模板卡片应清晰展示以下信息：
        *   **序号**：模板在列表中的顺序编号。
        *   **模板名称**：模板的标题，清晰标识其内容。
        *   **模板类型**：模板的分类，例如“日报”、“周报”等。
        *   **模板描述**：对模板的简要说明。
        *   **创建时间**：模板的创建日期和时间。
        *   **创建人**：创建该模板的用户。
        *   **更新时间**：模板的最近更新日期和时间。
        *   **发布状态**：显示模板当前的发布状态，例如“已发布”、“未发布”。

5.  **报告模板卡片的操作**：
    *   **功能**：提供对单个模板卡片的快捷操作。
    *   **操作元素**：
        *   **编辑按钮/图标**：点击后跳转至“新增/编辑模板”二级页面，并加载当前模板的内容进行编辑。模板的编辑状态不受发布状态影响。
        *   **发布MCP服务按钮/图标**：当模板未发布时显示。点击后将当前模板发布为MCP服务，使其可被大模型调用。发布后，此操作变为“取消发布”。
        *   **取消发布按钮/图标**：当模板已发布时显示。点击后取消当前模板的MCP服务发布状态，使其不再被大模型调用。
        *   **删除按钮/图标**：点击后弹出确认框，确认后删除当前模板。删除时需考虑权限和关联性检查。

### 名词解释

*   **MCP服务**：我司大模型平台可接入的微服务。发布为MCP服务后，大模型即可调用该模板生成报告。发布和取消发布操作仅控制模板在大模型平台上的可见性和调用权限，不影响模板本身的编辑状态。

### 数据模型（一级页面）

AI编码软件应能识别并生成以下数据模型，用于支持模板管理一级页面的数据存储和交互：

*   **报告模板表 (ReportTemplate)**：
    *   `id` (Primary Key, UUID/Int)
    *   `name` (String, Not Null) - 模板名称
    *   `description` (String, Nullable) - 模板描述
    *   `type` (String, Not Null) - 模板类型（例如：日报、周报等）
    *   `content_structure` (JSON/Text, Not Null) - 存储模板的详细内容结构，包括文本、数据指标占位符和维度内容。
    *   `is_published` (Boolean, Not Null, Default: False) - 发布状态，True表示已发布为MCP服务，False表示未发布。
    *   `created_at` (Timestamp, Not Null)
    *   `created_by` (String, Not Null) - 创建人用户ID或名称
    *   `updated_at` (Timestamp, Nullable)
    *   `updated_by` (String, Nullable)

## 二、二级页面：新增/编辑模板

### 页面功能

新增/编辑模板页面用于报告模板的详细配置。该页面采用Tab页设计，分为“报告编辑”和“关联工单”两个主要功能区域，集成了OnlyOffice富文本编辑能力、数据指标和报告维度的插入，以及关联工单条件的管理。

### 页面布局与元素

页面标题下方包含两个Tab页：**报告编辑** 和 **关联工单**。

### 2.1 Tab：报告编辑

#### 功能

“报告编辑”Tab是模板内容的核心编辑区域，用户可以在此配置模板的基本信息、编写报告正文，并动态插入数据指标和报告维度内容，同时实时预览报告效果。

#### 页面布局与元素

1.  **顶部 - 基本信息**：
    *   **功能**：配置报告模板的基础属性。
    *   **字段**：
        *   **模板名称**：文本输入框，必填项。用于标识报告模板的名称。
        *   **模板描述**：文本输入框，可选。对报告模板的简要说明。
        *   **模板类型**：下拉选择器，必选项。选项包括“日报”、“周报”、“月报”、“季报”、“半年报”、“年报”、“专题报告”。

2.  **左下侧 - 数据指标/报告维度**：
    *   **功能**：提供可插入到报告正文中的动态内容源，分为“数据指标”和“报告维度”两个子Tab。
    *   **布局**：分两个Tab显示两部分内容。
    *   **第一部分 - 数据指标**：
        *   **功能**：展示城市治理领域预设的数据指标列表。这些指标是系统内置的，用户无需关注其来源。
        *   **操作**：用户点击数据指标列表中的某个指标时，该指标的占位符（例如：`{{工单总量}}`、`{{满意度}}`）应自动插入到“中下侧-正文编辑”区域中当前光标所在位置。这些占位符在最终生成报告或模板预览时，将被替换为真实数据。
    *   **第二部分 - 报告维度**：
        *   **功能**：从“报告维度管理”模块中获取已定义的报告维度列表。
        *   **操作**：用户选择并选用某个报告维度后，该维度的内容将直接插入到“中下侧-正文编辑”区域中指定位置。同时，该维度中各章节内容对应的关联工单模块（即其配置的工单过滤条件）也将自动带入到“关联工单”Tab中。

3.  **中下侧 - 正文编辑**：
    *   **功能**：提供强大的富文本编辑能力，用于编写报告模板的详细正文内容。
    *   **核心组件**：
        *   **OnlyOffice富文本编辑器**：集成OnlyOffice编辑器的核心功能，支持文本格式、图片、表格等富文本编辑能力。
        *   **占位符插入**：
            *   点击“数据指标”时，将数据指标占位符插入到正文光标处。
            *   点击“报告维度”时，将维度模板内容（包括其内部的章节标题、文本和数据指标占位符）插入到正文光标处。
        *   **数据填充**：最终生成模板预览、报告等内容时，所有占位符（包括数据指标占位符和维度内容中的占位符）都将被替换为真实数据。

4.  **中右侧 - 模板预览**：
    *   **功能**：实时预览当前已配置模板的内容在实际报告中的效果，并支持通过简单的过滤条件进行数据填充预览。
    *   **默认状态**：默认向右收起，点击“展开预览”按钮后向左展开。
    *   **预览控制**：
        *   **过滤条件**：
            *   **上报时间**：日期范围选择器。
            *   **诉求来源**：下拉选择器。
            *   **所属区域**：下拉选择器。
            *   **诉求事项**：下拉选择器。
        *   **生成预览按钮**：点击后，系统根据当前模板内容结构和过滤条件，调用后端接口，填充真实数据，并在下方展示预览内容。预览内容应模拟最终报告的排版和样式。
    *   **预览内容**：展示填充数据后的模板内容，包括章节标题、文本、以及数据占位符被替换后的实际数值。对于包含关联工单的内容段落，其下方会显示一个“查看工单”的超链接。用户点击该链接后，将弹出一个工单列表的弹窗，并根据该内容段落设置的过滤条件反查工单。

### 2.2 Tab：关联工单

#### 概述

“关联工单”Tab用于管理报告模板中各个内容段落（特别是从维度中引入的内容）所关联的工单过滤条件。这些条件在报告生成时，用于将相关工单数据与报告内容进行绑定，方便用户在查看报告时进行工单反查。

#### 页面功能

*   **查询条件**：
    *   **内容名称**：文本输入框，对应维度中的内容名称，支持模糊查询。
    *   **具体内容**：文本输入框，对应维度中的内容的文本内容，支持模糊查询。
*   **操作栏**：
    *   **新增**：点击后弹出“新增/编辑弹窗”，用于手动添加新的关联工单配置。
    *   **批量删除**：当有内容列表项被选中时可用。点击后批量删除选中的关联工单配置。
*   **内容列表**：
    *   **功能**：展示模板中所有已配置关联工单的内容段落及其过滤条件。
    *   **列表项**：
        *   **内容名称**：对应维度中的内容名称。
        *   **具体内容**：对应维度中的内容的文本内容（可截断显示）。
        *   **诉求来源**：该内容段落关联的诉求来源过滤条件。
        *   **所属区域**：该内容段落关联的所属区域过滤条件。
        *   **诉求事项**：该内容段落关联的诉求事项过滤条件。
        *   **诉求标签**：该内容段落关联的诉求标签过滤条件。
*   **操作列**：
    *   **编辑**：点击后弹出“新增/编辑弹窗”，加载当前列表项的配置进行编辑。
    *   **删除**：点击后弹出确认框，确认后删除当前列表项的关联工单配置。
*   **新增/编辑弹窗**：
    *   **功能**：用于配置或修改单个内容段落的关联工单条件。
    *   **字段**：
        *   **内容名称**：文本输入框，必填项。用于标识当前关联工单配置所属的内容段落。
        *   **关联工单**：与“维度管理”中“新增/编辑一级内容/子内容”弹窗右侧的关联工单设置条件保持一致，包括：
            *   **诉求来源**：下拉选择器。
            *   **所属区域**：下拉选择器。
            *   **诉求事项**：下拉选择器。
            *   **诉求标签**：多选下拉选择器或标签输入框。
        *   **注意**：此处仅需设置过滤条件，不需关联具体的工单。

### 数据模型（二级页面）

AI编码软件应能识别并生成以下数据模型，用于支持新增/编辑模板页面的数据存储和交互。这些数据将存储在`ReportTemplate`表的`content_structure`字段中，并可能涉及与`Dimension`表的关联。

*   **报告模板内容结构 (ReportTemplateContentStructure)**：
    *   这是一个复杂的JSON结构，代表模板的整体内容，包括正文文本、数据指标占位符和嵌入的维度内容。
    *   `rich_text_content` (Text, Not Null) - OnlyOffice编辑器生成的富文本内容（HTML或OnlyOffice特定格式），包含数据指标占位符和维度内容占位符。
    *   `embedded_dimensions` (Array of EmbeddedDimension) - 嵌入到模板中的维度列表。

*   **嵌入维度 (EmbeddedDimension)**：
    *   `dimension_id` (UUID/Int, Not Null) - 引用自`Dimension`表的ID。
    *   `position` (Int, Not Null) - 维度内容在模板正文中的插入位置或顺序。
    *   `associated_work_order_configs` (Array of AssociatedWorkOrderConfig) - 维度中各章节内容对应的关联工单配置。

*   **关联工单配置 (AssociatedWorkOrderConfig)**：
    *   `content_name` (String, Not Null) - 对应维度中的内容名称。
    *   `content_text_preview` (String, Nullable) - 对应维度中的内容的文本内容预览。
    *   `filters` (JSON, Nullable) - 关联工单的过滤条件，例如：
        ```json
        {
            "appeal_source": ["微信", "电话"],
            "region": ["市辖区A"],
            "appeal_item": ["环境污染"],
            "appeal_tags": ["垃圾分类", "噪音污染"]
        }
        ```

## 总结

以上是对“报告模板管理”功能的详细描述，涵盖了从一级页面到二级Tab页的各项功能、布局和数据模型。这些信息旨在为AI编码软件提供足够清晰和全面的需求，以自动化生成智能报告管理子系统中的报告模板管理功能。

